<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Mobile Application Development for the iOS Platform"/><link rel="canonical" href="https://hococoder.com/posts/Week09/03-HKAccess"/><meta name="twitter:url" content="https://hococoder.com/posts/Week09/03-HKAccess"/><meta name="og:url" content="https://hococoder.com/posts/Week09/03-HKAccess"/><title>Week 9 - Getting HealthKit Access | Mobile Application Development for the iOS Platform</title><meta name="twitter:title" content="Week 9 - Getting HealthKit Access | Mobile Application Development for the iOS Platform"/><meta name="og:title" content="Week 9 - Getting HealthKit Access | Mobile Application Development for the iOS Platform"/><meta name="description" content="A description of my first post."/><meta name="twitter:description" content="A description of my first post."/><meta name="og:description" content="A description of my first post."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><link rel="stylesheet" href="../../../styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Mobile Application Development for the iOS Platform"/></head><body><header><div class="wrapper"><a class="site-name" href="/">Mobile Application Development for the iOS Platform</a><nav><ul><li><a href="/epp_605_687_fall_2023/posts/Intro/About Me">AboutMe</a></li><li><a href="/epp_605_687_fall_2023/posts/Intro/Example App">ExampleApp</a></li><li><a href="/epp_605_687_fall_2023/posts/Week00/00-Week00Overview">Week0</a></li><li><a href="/epp_605_687_fall_2023/posts/Week01/00-Week01Overview">Week1</a></li><li><a href="/epp_605_687_fall_2023/posts/Week02/00-Week02Overview">Week2</a></li><li><a href="/epp_605_687_fall_2023/posts/Week03/00-Week03Overview">Week3</a></li><li><a href="/epp_605_687_fall_2023/posts/Week04/00-Week04Overview">Week4</a></li><li><a href="/epp_605_687_fall_2023/posts/Week05/00-Week05Overview">Week5</a></li><li><a href="/epp_605_687_fall_2023/posts/Week06/00-Week06Overview">Week6</a></li><li><a href="/epp_605_687_fall_2023/posts/Week07/00-Week07Overview">Week7</a></li><li><a href="/epp_605_687_fall_2023/posts/Week08/00-Week08Overview">Week8</a></li><li><a href="/epp_605_687_fall_2023/posts/Week09/00-Week09Overview">Week9</a></li><li><a href="/epp_605_687_fall_2023/posts/Week10/00-Week10Overview">Week10</a></li><li><a href="/epp_605_687_fall_2023/posts/Week11/00-Week11Overview">Week11</a></li><li><a href="/epp_605_687_fall_2023/posts/Week12/00-Week12Overview">Week12</a></li><li><a href="/epp_605_687_fall_2023/posts/Week13/00-Week13Overview">Week13</a></li><li><a href="/epp_605_687_fall_2023/posts/Week14/00-Week14Overview">Week14</a></li></ul></nav></div></header><div class="wrapper"><h1>Week 9 - Getting HealthKit Access</h1><p style="float: left">Previous:  <A HREF="../02-HKEnabling/index.html">Enabling HealthKit</A></p><p style="float: right">Next:  <A HREF="../04-HKStaticData/index.html" class="nextModule">HealthKit Static Data</A></p><BR/><BR/><h2>Example - Authorization HealthKit Access</h2><center> <iframe width="1280" height="720" src="https://cdnapisec.kaltura.com/html5/html5lib/v2.81.2/mwEmbedFrame.php/p/1458241/uiconf_id/14487351/entry_id/1_ehyznznc?wid=_1458241&iframeembed=true&playerId=kaltura_player&entry_id=1_ehyznznc&flashvars[localizationCode]=en&amp;flashvars[leadWithHTML5]=true&amp;flashvars[sideBarContainer.plugin]=true&amp;flashvars[sideBarContainer.position]=left&amp;flashvars[sideBarContainer.clickToClose]=true&amp;flashvars[chapters.plugin]=true&amp;flashvars[chapters.layout]=vertical&amp;flashvars[chapters.thumbnailRotator]=false&amp;flashvars[streamSelector.plugin]=true&amp;flashvars[EmbedPlayer.SpinnerTarget]=videoHolder&amp;flashvars[dualScreen.plugin]=true&amp;flashvars[mediaProxy.preferedFlavorBR]=2500&amp;flashvars[Kaltura.addCrossoriginToIframe]=true&amp;flashvars[EmbedPlayer.NotPlayableDownloadLink]=true;&wid=1_abkvs1gz"allowfullscreen webkitallowfullscreen mozAllowFullScreen allow="autoplay *; fullscreen *; encrypted-media *" sandbox="allow-forms allow-same-origin allow-scripts allow-top-navigation allow-pointer-lock allow-popups allow-modals allow-orientation-lock allow-popups-to-escape-sandbox allow-presentation allow-top-navigation-by-user-activation" frameborder="0" title="Kaltura Player">
  </iframe>
</center><p>Due to the privacy requirements when using HealthKit, you have to ask the user for permission to read and write particular sets of information, such as body mass, steps count, and workouts, amongst many others. To get started with this, I've got a view on screen with a Button labeled "Authorize HealthKit". Let's see what we need to put in the closure to let us get access to HealthKit.</p><p class="new">The authorize method below now uses async throws, which is different from the video above.</p><p>Before we do that, however, we'll add a small error type that will come in handy when attempting to make connections to the store. Make an enum called HKError and have it adopt the Error protocol. The 2 cases are dataNotAvailable and typeNotAvailable - you’ll see where those will be used shortly.</p><pre><code><span class="keyword">enum</span> HKError : <span class="type">Error</span>
{
  <span class="keyword">case</span> dataNotAvailable
  <span class="keyword">case</span> typeNotAvailable
}
</code></pre><p>Before moving on, make sure HealthKit is imported in your file</p><pre><code><span class="keyword">import</span> HealthKit
</code></pre><p>Next, make a class function called authorizeHealthKit, which is <code>async throws</code> and returns Void.</p><pre><code>  <span class="keyword">func</span> authorizeHealthKit() <span class="keyword">async throws</span>
  {
</code></pre><p>In the authorizeHealthKit method, first check to see that health data is available by doing a guard check on HKHealthStore.isHealthDataAvailble. If it isn’t - which means the app has been routed into the guard’s else block - throw the <code>HKError.dataNotAvailable</code></p><pre><code>    <span class="keyword">guard</span> <span class="type">HKHealthStore</span>.<span class="call">isHealthDataAvailable</span>() <span class="keyword">else</span> { <span class="keyword">throw</span> <span class="type">HKError</span>.<span class="property">dataNotAvailable</span> }
</code></pre><p>If it makes it past the guard, use another guard statement to initialize a series of data types that we will want to use in the app. Note here that we are using one guard statement, which a series of checks separated by commas. If any one of those fails, the guard statement fails and we’re sent into the else block, throw a HKError.typeNotAvailable error type.</p><pre><code>    <span class="comment">//types of data to read or write</span>
    <span class="keyword">guard let</span> dateOfBirth = <span class="type">HKObjectType</span>.<span class="call">characteristicType</span>(forIdentifier: .<span class="dotAccess">dateOfBirth</span>),
      <span class="keyword">let</span> bodyMass = <span class="type">HKObjectType</span>.<span class="call">quantityType</span>(forIdentifier: .<span class="dotAccess">bodyMass</span>),
      <span class="keyword">let</span> steps = <span class="type">HKObjectType</span>.<span class="call">quantityType</span>(forIdentifier: <span class="type">HKQuantityTypeIdentifier</span>.<span class="property">stepCount</span>)
      <span class="keyword">else</span> {
        <span class="keyword">throw</span> <span class="type">HKError</span>.<span class="property">typeNotAvailable</span>
    }
</code></pre><p>If they all succeed however we can continue on and use those types to define the list of types we want to write to, and the list of types we want to read from - we have to list and ask for them separately, because you may not want to both read and write for a given type.</p><pre><code>    <span class="comment">//setup the types to write and read</span>
    <span class="keyword">let</span> healthKitTypesToWrite: <span class="type">Set</span>&lt;<span class="type">HKSampleType</span>&gt; = [bodyMass, <span class="type">HKObjectType</span>.<span class="call">workoutType</span>()]
  
    <span class="keyword">let</span> healthKitTypesToRead: <span class="type">Set</span>&lt;<span class="type">HKObjectType</span>&gt; = [dateOfBirth,
                                                 bodyMass,
                                                 steps,
                                                 <span class="type">HKObjectType</span>.<span class="call">workoutType</span>()]
</code></pre><p>Finally, call HKHealthStore requestAuthorization(toShare:, read:), using try await, passing in the groups we just defined. The call will either return attempt to show the authorization dialog or throw an error.</p><pre><code>    <span class="keyword">try await</span> hkStore.<span class="call">requestAuthorization</span>(toShare: healthKitTypesToWrite, read: healthKitTypesToRead)
  }
</code></pre><p>Finally, go back up to the view so we can fill in the action handler for the Button. Call the <code>authorizeHealthKit</code> method we just definedusing <code>try await</code>. This attempt is in a <code>do/catch</code>: if the code stays in the <code>do</code> block, it has succeeded, and you can attempt to download what data the user has authorized. If the <code>catch</code> block is reached, an error has been thrown, so print it out.</p><pre><code><span class="type">Button</span>(<span class="string">"Authorize HealthKit"</span>) {
  <span class="type">Task</span> {
    <span class="keyword">do</span> {
      <span class="keyword">try await self</span>.<span class="call">authorizeHealthKit</span>()
      <span class="call">print</span>(<span class="string">"HealthKit Successfully Authorized."</span>)
      <span class="keyword">self</span>.<span class="property">hkData</span>.<span class="call">loadData</span>()
      <span class="type">UserDefaults</span>.<span class="property">standard</span>.<span class="call">set</span>(<span class="keyword">true</span>, forKey: <span class="string">"hkAuthorized"</span>)
      <span class="keyword">self</span>.<span class="property">hkEnabled</span>.<span class="call">toggle</span>()
    } <span class="keyword">catch</span> {
      <span class="keyword">let</span> baseMessage = <span class="string">"HealthKit Authorization Failed"</span>
      <span class="call">print</span>(<span class="string">"</span>\(baseMessage)<span class="string">. Reason:</span> \(error.<span class="property">localizedDescription</span>)<span class="string">"</span>)
    }
  }
}
</code></pre><p>Surround that button with a check to see if the <code>hkEnabled</code> property is false, and use that to device whether to show the Authorize view or a view that will show us some HealthKit data, which we'll define in the next video.</p><pre><code><span class="keyword">if</span> !hkEnabled || !<span class="type">UserDefaults</span>.<span class="property">standard</span>.<span class="call">bool</span>(forKey: <span class="string">"hkAuthorized"</span>) {
  <span class="type">Button</span>(<span class="string">"Authorize HealthKit"</span>) {
    <span class="type">Task</span> {
      <span class="keyword">do</span> {
        <span class="keyword">try await self</span>.<span class="call">authorizeHealthKit</span>()
        <span class="call">print</span>(<span class="string">"HealthKit Successfully Authorized."</span>)
        <span class="keyword">self</span>.<span class="property">hkData</span>.<span class="call">loadData</span>()
        <span class="type">UserDefaults</span>.<span class="property">standard</span>.<span class="call">set</span>(<span class="keyword">true</span>, forKey: <span class="string">"hkAuthorized"</span>)
        <span class="keyword">self</span>.<span class="property">hkEnabled</span>.<span class="call">toggle</span>()
      } <span class="keyword">catch</span> {
        <span class="keyword">let</span> baseMessage = <span class="string">"HealthKit Authorization Failed"</span>
        <span class="call">print</span>(<span class="string">"</span>\(baseMessage)<span class="string">. Reason:</span> \(error.<span class="property">localizedDescription</span>)<span class="string">"</span>)
      }
    }
  }
}
<span class="keyword">else</span> {
  <span class="type">Text</span>(<span class="string">"HealthKit data will go here"</span>)
}
</code></pre><p>Start this in the simulator. Press the Authorize button, and you’ll see HealthKit’s authorize view pop up - keep in mind you didn’t have to define any of this user interface, other than the types! - and allows the user to choose what to allow to share or write to in this app. Click the “Turn all categories on” button and hit Allow - and if you look in the console, you’ll see our “HK Successfully authorized” statement, showing that we’re all ready to go. Establishing a connection to the HealthKit store is pretty easy - just define the types you want to read or write, pass those to the authorization method, and HealthKit does all the heavy lifting by displaying a nice user interface for your user to choose data types from.</p><p>If you have any questions about the examples in this video, please post them in the forums.</p><p style="float: left">Previous:  <A HREF="../02-HKEnabling/index.html">Enabling HealthKit</A></p><p style="float: right">Next:  <A HREF="../04-HKStaticData/index.html" class="nextModule">HealthKit Static Data</A></p></div><footer><p>Generated with ❤️ using <a href="https://github.com/johnsundell/publish">Publish</a></p><p>© 2023-2024 Josh Steele (rsteele3@jhu.edu) <a href="mailto:"(rsteele3@jhu.edu)""></a></p><p>Last updated August 27, 2023 at 5:26 PM</p><p><a href="https://mastodon.social/@hococoder" target="_blank">My Mastodon</a> | <a href="https://github.com/hococoder" target="_blank">My GitHub</a> | <a href="https://ep.jhu.edu" target="_blank">Whiting School EPP</a> | <a href="https://canvas.jhu.edu" target="_blank">JHU Canvas</a></p></footer></body></html>