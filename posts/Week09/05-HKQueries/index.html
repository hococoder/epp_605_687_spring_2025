<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Mobile Application Development for the iOS Platform"/><link rel="canonical" href="https://hococoder.com/posts/Week09/05-HKQueries"/><meta name="twitter:url" content="https://hococoder.com/posts/Week09/05-HKQueries"/><meta name="og:url" content="https://hococoder.com/posts/Week09/05-HKQueries"/><title>Week 9 - HealthKit Queries | Mobile Application Development for the iOS Platform</title><meta name="twitter:title" content="Week 9 - HealthKit Queries | Mobile Application Development for the iOS Platform"/><meta name="og:title" content="Week 9 - HealthKit Queries | Mobile Application Development for the iOS Platform"/><meta name="description" content="A description of my first post."/><meta name="twitter:description" content="A description of my first post."/><meta name="og:description" content="A description of my first post."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="../../../styles.css" type="text/css"/><script src="../../../../jquery-3.7.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Mobile Application Development for the iOS Platform"/></head><body><div class="layout"><div class="header"><div class="headerLayout"><div class="title">Mobile Application Development for the iOS Platform</div><div class="subtitle">Engineering Program for Professionals - 605.687 - 2024-2025 Academic Year</div><div class="weeklayout"><a class="grow1" href="/epp_605_687_spring_2025/posts/Intro/About Me">About Me</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Intro/Example App">Example App</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week00/00-Week00Overview">Week 0</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week01/00-Week01Overview">Week 1</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week02/00-Week02Overview">Week 2</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week03/00-Week03Overview">Week 3</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week04/00-Week04Overview">Week 4</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week05/00-Week05Overview">Week 5</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week06/00-Week06Overview">Week 6</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week07/00-Week07Overview">Week 7</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week08/00-Week08Overview">Week 8</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week09/00-Week09Overview">Week 9</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week10/00-Week10Overview">Week 10</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week11/00-Week11Overview">Week 11</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week12/00-Week12Overview">Week 12</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week13/00-Week13Overview">Week 13</a></div></div></div><div class="wrapper"><h1>Week 9 - HealthKit Queries</h1><p style="float: left">Previous:  <A HREF="../../Week09/04-HKStaticData/index.html">HKStaticData</A></p><p style="float: right">Next:  <A HREF="../../Week09/06-HKStatistics/index.html">HKStatistics</A></p><BR/><BR/><a name="exampleQueryingHistoricalData"></a>
<h2>Example - Querying Historical Data</h2><center><iframe src="https://jh.hosted.panopto.com/Panopto/Pages/Embed.aspx?id=250e5d38-e7b6-4bf6-a701-b1bb0119c0be&autoplay=false&offerviewer=true&showtitle=true&showbrand=true&captions=false&interactivity=all" height="720" width="1280" style="border: 1px solid #464646;" allowfullscreen allow="autoplay" aria-label="Panopto Embedded Video Player" aria-description="Week0-04-THIRDPARTYTOOLS-Lecture" ></iframe></center><p>Let's look at how you can read historical data, such as weight, instead of static information such as the birthdate from before. In the <code>HealthKitDataHelper</code> class, let's add a method that will collect data from the last 7 days, and call it <code>readHistoricalData</code>. It will take in a <code>HKSampleType</code> as well as a closure to return values from the lookup - remember, getting data from HealthKit may take a bit of time, so the queries are handled on background threads and returned to the caller via closures.</p><pre><code><span class="keyword">@Published var</span> weight: <span class="type">Double</span> = <span class="number">0.0</span>

<span class="comment">//Query to read data from the past 7 days</span>
<span class="keyword">func</span> readHistoricalData(for sampleType: <span class="type">HKSampleType</span>,
                        completion: <span class="keyword">@escaping</span> (<span class="type">HKQuantitySample</span>?, <span class="type">Error</span>?) -&gt; ())
{
</code></pre><p>Restrict the time range for our query by using <code>HKQuery.predicateForSamples</code>, providing start and end dates, as well as the <code>strictEndTime</code> which dictates that the sample's end time must be less than the query's end time</p><pre><code>   <span class="comment">//restrict the date range</span>
  <span class="keyword">let</span> mostRecentPredicate = <span class="type">HKQuery</span>.<span class="call">predicateForSamples</span>(withStart: <span class="type">Date</span>() - <span class="number">7</span>*<span class="number">86400</span>,
                                                        end: <span class="type">Date</span>(),
                                                        options: .<span class="dotAccess">strictEndDate</span>)
</code></pre><p>We can also sort the data with a <code>NSSortDescriptor</code> - here we'll sort by the <code>HKSampleSortIdentifierStartDate</code></p><pre><code>   <span class="comment">//sort the returned values</span>
  <span class="keyword">let</span> sortDescriptor = <span class="type">NSSortDescriptor</span>(key: <span class="type">HKSampleSortIdentifierStartDate</span>, ascending: <span class="keyword">false</span>)
</code></pre><p>Now let's make the query. For the purposes of this demo, we'll just grab the most recent value, and use the sort descriptor and predicate we defined earlier. In the closure, define what should happen when a response comes back from the <code>HKStore</code>. Again, since we'll be updating UI-related properties, be sure to handle things on the main thread. Use a <code>guard</code> to handle the error case, calling the completon handler with a nil sample and a non-nil error if that happens; otherwise, call the completion with the <code>mostRecentSample</code> and a nil error. Don't forget to execute the <code>query</code> on the <code>HKHealthStore</code> once you've made it!</p><pre><code>   <span class="comment">//formulate the query, limit it to the most recent (1), and define a closure once the value is retrieved</span>
  <span class="keyword">let</span> sampleQuery = <span class="type">HKSampleQuery</span>(sampleType: sampleType,
                                  predicate: mostRecentPredicate,
                                  limit: <span class="number">1</span>,
                                  sortDescriptors: [sortDescriptor])
  {
    (query, samples, error) <span class="keyword">in</span>
    
    <span class="comment">//Remember, the main thread is where all UI changes should take place</span>
    <span class="type">DispatchQueue</span>.<span class="property">main</span>.<span class="call">async</span>
      {
        <span class="comment">//do a guard check to make sure that samples were returned, and grab the one returned</span>
        <span class="keyword">guard let</span> samples = samples, <span class="keyword">let</span> mostRecentSample = samples.<span class="property">first</span> <span class="keyword">as</span>? <span class="type">HKQuantitySample</span>
          <span class="keyword">else</span> {
            <span class="comment">//in the case of an error, return a nil sample, and the error passed into the closure</span>
            <span class="call">completion</span>(<span class="keyword">nil</span>, error)
            <span class="keyword">return</span>
        }
        <span class="comment">//we're successful if we got here, so return the sample and a nil error object</span>
        <span class="call">completion</span>(mostRecentSample, <span class="keyword">nil</span>)
    }
  }
  <span class="comment">//Execute the query on the store (don't forget this!)</span>
  <span class="type">HKHealthStore</span>().<span class="call">execute</span>(sampleQuery)
}
</code></pre><p>With this in place, go up and and make a <code>readWeight()</code> function to use here, and add it to the <code>loadData</code> function.</p><pre><code><span class="keyword">func</span> readWeight() {
  <span class="call">readHistoricalData</span>(for: <span class="type">HKObjectType</span>.<span class="call">quantityType</span>(forIdentifier: .<span class="dotAccess">bodyMass</span>)!, completion:
    {
      sample, error <span class="keyword">in
      guard let</span> sample = sample <span class="keyword">else</span> { <span class="call">print</span>(<span class="string">"error getting sample</span> \(<span class="type">String</span>(describing: error?.<span class="property">localizedDescription</span>))<span class="string">"</span>); <span class="keyword">return</span> }
      <span class="keyword">self</span>.<span class="property">weight</span> = sample.<span class="property">quantity</span>.<span class="call">doubleValue</span>(for: <span class="type">HKUnit</span>.<span class="call">pound</span>())
  })
}
</code></pre><p>We’re going to get the patient’s body mass, so that is the type we’ll pass in, and in our completion handler, we will do our standard check for nil values, and if everything gets past the guard, set the <code>weight</code> property to be the sample’s quantity, represented as a pound thanks to the <code>doubleValue</code> for method, which takes in a unit to do the conversion. Make sure that you explicitly unwrap the <code>HKObjectType</code> when you pass it into the <code>readHistoricalData</code> method.</p><p>Before running this in the simulator, add a field to the <code>Form</code> in our view to display the weight</p><pre><code><span class="type">HStack</span> {
  <span class="type">Text</span>(<span class="string">"Weight (lbs)"</span>)
  <span class="type">Spacer</span>()
  <span class="type">Text</span>(<span class="string">"</span>\(numberFormatter.<span class="call">string</span>(from: <span class="type">NSNumber</span>(value: hkData.<span class="property">weight</span>))!)<span class="string">"</span>)
}
</code></pre><p>Run this in the simulator, and you can see that the most recent weight is being shown in our view as intended. Historical data such as weight can easily be retrieved from the health kit store by defining the proper parameters for the sample query, and once you have that data, you can display it on screen just like you want.<br><br>If you have any questions about the examples in this video, please post them in the forums.</p><p style="float: left">Previous:  <A HREF="../../Week09/04-HKStaticData/index.html">HKStaticData</A></p><p style="float: right">Next:  <A HREF="../../Week09/06-HKStatistics/index.html">HKStatistics</A></p><BR/><BR/></div><leftside><u><p>Week 9</p></u><div class="weekSection"><ul><li><div class="comment-container"><div class="tocItem"><a id="Week 09 Overview" href="../../Week09/00-Week09Overview/index.html">Week 09 Overview</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="Introduction to HealthKit" href="../../Week09/01-IntroductionToHealthKit/index.html">Introduction to HealthKit</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="HKEnabling" href="../../Week09/02-HKEnabling/index.html">HKEnabling</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="HKAccess" href="../../Week09/03-HKAccess/index.html">HKAccess</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="HKStaticData" href="../../Week09/04-HKStaticData/index.html">HKStaticData</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="HKQueries" href="../../Week09/05-HKQueries/index.html">HKQueries</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="HKStatistics" href="../../Week09/06-HKStatistics/index.html">HKStatistics</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="HKWriteData" href="../../Week09/07-HKWriteData/index.html">HKWriteData</a></div></div></li></ul></div></leftside><footer><p>Generated with ❤️ using <a href="https://github.com/johnsundell/publish">Publish</a></p><p>© 2023-2024 Josh Steele (rsteele3@jhu.edu) <a href="mailto:"(rsteele3@jhu.edu)""></a></p><p>Last updated January 25, 2025 at 1:51 PM</p><p><a href="https://mastodon.social/@hococoder" target="_blank">My Mastodon</a> | <a href="https://github.com/hococoder" target="_blank">My GitHub</a> | <a href="https://ep.jhu.edu" target="_blank">Whiting School EPP</a> | <a href="https://canvas.jhu.edu" target="_blank">JHU Canvas</a></p></footer></div></body></html>