<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Mobile Application Development for the iOS Platform"/><link rel="canonical" href="https://hococoder.com/posts/Week08/07-IAPPurchasing"/><meta name="twitter:url" content="https://hococoder.com/posts/Week08/07-IAPPurchasing"/><meta name="og:url" content="https://hococoder.com/posts/Week08/07-IAPPurchasing"/><title>Week 8 - Purchasing of In App Purchases | Mobile Application Development for the iOS Platform</title><meta name="twitter:title" content="Week 8 - Purchasing of In App Purchases | Mobile Application Development for the iOS Platform"/><meta name="og:title" content="Week 8 - Purchasing of In App Purchases | Mobile Application Development for the iOS Platform"/><meta name="description" content="A description of my first post."/><meta name="twitter:description" content="A description of my first post."/><meta name="og:description" content="A description of my first post."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><link rel="stylesheet" href="../../../styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Mobile Application Development for the iOS Platform"/></head><body><header><div class="wrapper"><a class="site-name" href="/">Mobile Application Development for the iOS Platform</a><nav><ul><li><a href="/epp_605_687_fall_2023/posts/Intro/About Me">AboutMe</a></li><li><a href="/epp_605_687_fall_2023/posts/Intro/Example App">ExampleApp</a></li><li><a href="/epp_605_687_fall_2023/posts/Week00/00-Week00Overview">Week0</a></li><li><a href="/epp_605_687_fall_2023/posts/Week01/00-Week01Overview">Week1</a></li><li><a href="/epp_605_687_fall_2023/posts/Week02/00-Week02Overview">Week2</a></li><li><a href="/epp_605_687_fall_2023/posts/Week03/00-Week03Overview">Week3</a></li><li><a href="/epp_605_687_fall_2023/posts/Week04/00-Week04Overview">Week4</a></li><li><a href="/epp_605_687_fall_2023/posts/Week05/00-Week05Overview">Week5</a></li><li><a href="/epp_605_687_fall_2023/posts/Week06/00-Week06Overview">Week6</a></li><li><a href="/epp_605_687_fall_2023/posts/Week07/00-Week07Overview">Week7</a></li><li><a href="/epp_605_687_fall_2023/posts/Week08/00-Week08Overview">Week8</a></li><li><a href="/epp_605_687_fall_2023/posts/Week09/00-Week09Overview">Week9</a></li><li><a href="/epp_605_687_fall_2023/posts/Week10/00-Week10Overview">Week10</a></li><li><a href="/epp_605_687_fall_2023/posts/Week11/00-Week11Overview">Week11</a></li><li><a href="/epp_605_687_fall_2023/posts/Week12/00-Week12Overview">Week12</a></li><li><a href="/epp_605_687_fall_2023/posts/Week13/00-Week13Overview">Week13</a></li><li><a href="/epp_605_687_fall_2023/posts/Week14/00-Week14Overview">Week14</a></li></ul></nav></div></header><div class="wrapper"><h1>Week 8 - Purchasing of In App Purchases</h1><p style="float: left">Previous:  <A HREF="../06-IAPItemsList/index.html">Getting a List of In App Purchases</A></p><p style="float: right">Next:  <A HREF="../../Week09/00-Week09Overview/index.html">Week 9 Overview</A></p><BR/><BR/><h2>Example - Purchasing IAP and Activating them in Your App</h2><center> <iframe width="1280" height="720" src="https://cdnapisec.kaltura.com/html5/html5lib/v2.81.2/mwEmbedFrame.php/p/1458241/uiconf_id/14487351/entry_id/1_86xnscqn?wid=_1458241&iframeembed=true&playerId=kaltura_player&entry_id=1_86xnscqn&flashvars[localizationCode]=en&amp;flashvars[leadWithHTML5]=true&amp;flashvars[sideBarContainer.plugin]=true&amp;flashvars[sideBarContainer.position]=left&amp;flashvars[sideBarContainer.clickToClose]=true&amp;flashvars[chapters.plugin]=true&amp;flashvars[chapters.layout]=vertical&amp;flashvars[chapters.thumbnailRotator]=false&amp;flashvars[streamSelector.plugin]=true&amp;flashvars[EmbedPlayer.SpinnerTarget]=videoHolder&amp;flashvars[dualScreen.plugin]=true&amp;flashvars[mediaProxy.preferedFlavorBR]=2500&amp;flashvars[Kaltura.addCrossoriginToIframe]=true&amp;flashvars[EmbedPlayer.NotPlayableDownloadLink]=true;&wid=1_abkvs1gz"allowfullscreen webkitallowfullscreen mozAllowFullScreen allow="autoplay *; fullscreen *; encrypted-media *" sandbox="allow-forms allow-same-origin allow-scripts allow-top-navigation allow-pointer-lock allow-popups allow-modals allow-orientation-lock allow-popups-to-escape-sandbox allow-presentation allow-top-navigation-by-user-activation" frameborder="0" title="Kaltura Player">
  </iframe>
</center><p>Let's add some functionality to carry out purchases and activate the purchased behavior in your app.</p><p>Let’s make a few variables in the IAPDelegate class - one for the index of the selectedProduct, and another to tell whether a transaction is in progress.</p><pre><code>   <span class="comment">//purchase</span>
  <span class="keyword">var</span> selectedProduct:<span class="type">Int</span>!
  <span class="keyword">var</span> transactionInProgress = <span class="keyword">false</span>
</code></pre><p>In the init method, add this class to the <code>SKPaymentQueue</code>’s default queue. To do this, you have to adopt the <code>SKPaymentTransactionObserver</code> protocol, which we did in the last video. This allows the class to respond to purchase actions made to the store.</p><pre><code>   <span class="keyword">override init</span>() {
    <span class="keyword">super</span>.<span class="keyword">init</span>()
    <span class="comment">//product list</span>
    productIDs.<span class="call">append</span>(<span class="string">"edu.jhu.ep.steele.josh.EPExampleAppF20.DisableAdsIAP"</span>)
    <span class="keyword">self</span>.<span class="call">requestProductsFromStore</span>()

    <span class="comment">//payment</span>
    <span class="type">SKPaymentQueue</span>.<span class="call">default</span>().<span class="call">add</span>(<span class="keyword">self</span>)
  }
</code></pre><p>Going back to the <code>IAPListing</code> struct, let's focus in on the action for the Buy button of the alert. Setup an <code>SKPayment</code> object using the selected <code>SKProduct</code>, and add that payment to the <code>SKPaymentQueue</code>’s default queue. Also - mark that <code>transactionInProgress</code> is true. Remember - our communication with the store is happening asynchronously, so we don’t want to initiate another purchase while we are waiting for the current one to finish.</p><pre><code><span class="type">Alert</span>(title: <span class="type">Text</span>(<span class="string">"EPExampleApp"</span>), message: <span class="type">Text</span>(<span class="string">"Purchase This?"</span>),
     primaryButton: .<span class="call">default</span>(<span class="type">Text</span>(<span class="string">"Buy"</span>)) {
       <span class="keyword">self</span>.<span class="property">iapDelegate</span>.<span class="property">selectedProduct</span> = <span class="keyword">self</span>.<span class="property">iapDelegate</span>.<span class="property">productsArray</span>.<span class="call">firstIndex</span>(of: item)
       <span class="keyword">let</span> payment = <span class="type">SKPayment</span>(product: <span class="keyword">self</span>.<span class="property">iapDelegate</span>.<span class="property">productsArray</span>[<span class="keyword">self</span>.<span class="property">iapDelegate</span>.<span class="property">selectedProduct</span>] <span class="keyword">as</span> <span class="type">SKProduct</span>)
       <span class="type">SKPaymentQueue</span>.<span class="call">default</span>().<span class="call">add</span>(payment)
       <span class="keyword">self</span>.<span class="property">iapDelegate</span>.<span class="property">transactionInProgress</span> = <span class="keyword">true
       self</span>.<span class="property">alertIsShowing</span> = <span class="keyword">false</span>
     },
     secondaryButton: .<span class="call">cancel</span>(<span class="type">Text</span>(<span class="string">"No"</span>)){
       <span class="keyword">self</span>.<span class="property">alertIsShowing</span> = <span class="keyword">false</span>
     })
 })
</code></pre><p>OK, let's go back to the <code>IAPViewDelegate</code> class, and implement our method from the observer protocol. <code>paymentQueue(_:updatedTransactions:)</code> is our focus here. We’ll look at the transactions that were handed back to us from the store, and in particular the transaction state. Let’s make a switch statement to handle our different cases.</p><pre><code><span class="comment">//payment</span>
<span class="keyword">func</span> paymentQueue(<span class="keyword">_</span> queue: <span class="type">SKPaymentQueue</span>, updatedTransactions transactions: [<span class="type">SKPaymentTransaction</span>])
{
  <span class="keyword">for</span> transaction <span class="keyword">in</span> transactions
  {
    <span class="keyword">switch</span> transaction.<span class="property">transactionState</span>
    {
    <span class="keyword">case</span> .<span class="dotAccess">purchased</span>:
      <span class="call">print</span>(<span class="string">"Transaction completed successfully."</span>)
      <span class="type">SKPaymentQueue</span>.<span class="call">default</span>().<span class="call">finishTransaction</span>(transaction)
      transactionInProgress = <span class="keyword">false</span>
      unlockAds()
      
    <span class="keyword">case</span> .<span class="dotAccess">failed</span>:
      <span class="call">print</span>(<span class="string">"Transaction Failed"</span>);
      <span class="type">SKPaymentQueue</span>.<span class="call">default</span>().<span class="call">finishTransaction</span>(transaction)
      transactionInProgress = <span class="keyword">false
      
    default</span>:
      <span class="call">print</span>(transaction.<span class="property">transactionState</span>.<span class="property">rawValue</span>)
    }
  }
}
</code></pre><p>Let's break that down:</p><ul><li>If it’s purchased, we’ll note the transaction as finished, set <code>transactionInProgress</code> to false, and call our <code>unlockAds</code> method.</li><li>If the transaction failed, again mark the transaction as finished, and set the <code>transactionInProgress</code> to false, but don’t call our <code>unlockAds</code> method.</li><li>Be sure to catch the default cases for the switch (we’re not handling them all here).</li></ul><p>Finally let’s make our very simple <code>unlockAds</code>unlockAds method, which simply sets that showAds flag in the UserDefaults to false.</p><pre><code><span class="comment">//unlock functionality</span>
<span class="keyword">func</span> unlockAds()
{
  <span class="keyword">let</span> defaults = <span class="type">UserDefaults</span>.<span class="property">standard</span>
  defaults.<span class="call">set</span>(<span class="keyword">false</span>, forKey: <span class="string">"showAds"</span>)
}
</code></pre><p>Let’s run that in the simulator.</p><p>Push the button to get our list of IAP, and select the Disable Ads item. We see our dialog asking if the user wants to purchase the IAP or not.</p><p>If we were going through App Store Connect, we don’t have this IAP in a state that we can properly test it (it’s not marked as Ready for sale), so we won’t go any further down the purchase path. If we did select “Buy”, it would add our payment to the queue, and when the store responds, the <code>paymentQueue(_:updatedTransactions:)</code> method gets invoked - and we respond accordingly based on the transaction state.</p><p>However, we have our StoreKit Configuration File setup, so you can go through the full test process - the dialog even comments that this is for testing purposes only and you won't be charged.<br><br>It doesn’t take much to get in app purchases in your app, and it makes heavy use of delegate methods to handle responses from the store.</p><p>If you have any questions about the example in this video, please post them in the forums.</p><p style="float: left">Previous:  <A HREF="../06-IAPItemsList/index.html">Getting a List of In App Purchases</A></p><p style="float: right">Next:  <A HREF="../../Week09/00-Week09Overview/index.html">Week 9 Overview</A></p></div><footer><p>Generated with ❤️ using <a href="https://github.com/johnsundell/publish">Publish</a></p><p>© 2023-2024 Josh Steele (rsteele3@jhu.edu) <a href="mailto:"(rsteele3@jhu.edu)""></a></p><p>Last updated September 4, 2023 at 10:46 AM</p><p><a href="https://mastodon.social/@hococoder" target="_blank">My Mastodon</a> | <a href="https://github.com/hococoder" target="_blank">My GitHub</a> | <a href="https://ep.jhu.edu" target="_blank">Whiting School EPP</a> | <a href="https://canvas.jhu.edu" target="_blank">JHU Canvas</a></p></footer></body></html>