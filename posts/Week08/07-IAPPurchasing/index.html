<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Mobile Application Development for the iOS Platform"/><link rel="canonical" href="https://hococoder.com/posts/Week08/07-IAPPurchasing"/><meta name="twitter:url" content="https://hococoder.com/posts/Week08/07-IAPPurchasing"/><meta name="og:url" content="https://hococoder.com/posts/Week08/07-IAPPurchasing"/><title>Week 8 - Purchasing of In App Purchases | Mobile Application Development for the iOS Platform</title><meta name="twitter:title" content="Week 8 - Purchasing of In App Purchases | Mobile Application Development for the iOS Platform"/><meta name="og:title" content="Week 8 - Purchasing of In App Purchases | Mobile Application Development for the iOS Platform"/><meta name="description" content="A description of my first post."/><meta name="twitter:description" content="A description of my first post."/><meta name="og:description" content="A description of my first post."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="../../../styles.css" type="text/css"/><script src="../../../../jquery-3.7.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Mobile Application Development for the iOS Platform"/></head><body><div class="layout"><div class="header"><div class="headerLayout"><div class="title">Mobile Application Development for the iOS Platform</div><div class="subtitle">Engineering Program for Professionals - 605.687 - 2024-2025 Academic Year</div><div class="weeklayout"><a class="grow1" href="/epp_605_687_spring_2025/posts/Intro/About Me">About Me</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Intro/Example App">Example App</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week00/00-Week00Overview">Week 0</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week01/00-Week01Overview">Week 1</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week02/00-Week02Overview">Week 2</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week03/00-Week03Overview">Week 3</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week04/00-Week04Overview">Week 4</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week05/00-Week05Overview">Week 5</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week06/00-Week06Overview">Week 6</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week07/00-Week07Overview">Week 7</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week08/00-Week08Overview">Week 8</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week09/00-Week09Overview">Week 9</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week10/00-Week10Overview">Week 10</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week11/00-Week11Overview">Week 11</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week12/00-Week12Overview">Week 12</a><a class="grow1" href="/epp_605_687_spring_2025/posts/Week13/00-Week13Overview">Week 13</a></div></div></div><div class="wrapper"><h1>Week 8 - Purchasing of In App Purchases</h1><p style="float: left">Previous:  <A HREF="../../Week08/06-IAPItemsList/index.html">IAP Items List</A></p><p style="float: right">Next:  <A HREF="../../Week09/00-Week09Overview/index.html">Week 09 Overview</A></p><BR/><BR/><a name="examplePurchasingIapAndActivatingThemInYourApp"></a>
<h2>Example - Purchasing IAP and Activating them in Your App</h2><center><iframe id="myIframe" src="https://jh.hosted.panopto.com/Panopto/Pages/Embed.aspx?id=21e8e137-0fc4-405d-baa0-b1bb0118b875&autoplay=false&offerviewer=true&showtitle=true&showbrand=true&captions=false&interactivity=all"  style="border: 1px solid #464646;" allowfullscreen allow="autoplay" aria-label="Panopto Embedded Video Player" aria-description="Week0-04-THIRDPARTYTOOLS-Lecture" ></iframe></center><p>Let's add some functionality to carry out purchases and activate the purchased behavior in your app.</p><p>Let’s make a few variables in the IAPDelegate class - one for the index of the selectedProduct, and another to tell whether a transaction is in progress.</p><pre><code>   <span class="comment">//purchase</span>
  <span class="keyword">var</span> selectedProduct:<span class="type">Int</span>!
  <span class="keyword">var</span> transactionInProgress = <span class="keyword">false</span>
</code></pre><p>In the init method, add this class to the <code>SKPaymentQueue</code>’s default queue. To do this, you have to adopt the <code>SKPaymentTransactionObserver</code> protocol, which we did in the last video. This allows the class to respond to purchase actions made to the store.</p><pre><code>   <span class="keyword">override init</span>() {
    <span class="keyword">super</span>.<span class="keyword">init</span>()
    <span class="comment">//product list</span>
    productIDs.<span class="call">append</span>(<span class="string">"edu.jhu.ep.steele.josh.EPExampleAppF20.DisableAdsIAP"</span>)
    <span class="keyword">self</span>.<span class="call">requestProductsFromStore</span>()

    <span class="comment">//payment</span>
    <span class="type">SKPaymentQueue</span>.<span class="call">default</span>().<span class="call">add</span>(<span class="keyword">self</span>)
  }
</code></pre><p>Going back to the <code>IAPListing</code> struct, let's focus in on the action for the Buy button of the alert. Setup an <code>SKPayment</code> object using the selected <code>SKProduct</code>, and add that payment to the <code>SKPaymentQueue</code>’s default queue. Also - mark that <code>transactionInProgress</code> is true. Remember - our communication with the store is happening asynchronously, so we don’t want to initiate another purchase while we are waiting for the current one to finish.</p><pre><code><span class="type">Alert</span>(title: <span class="type">Text</span>(<span class="string">"EPExampleApp"</span>), message: <span class="type">Text</span>(<span class="string">"Purchase This?"</span>),
     primaryButton: .<span class="call">default</span>(<span class="type">Text</span>(<span class="string">"Buy"</span>)) {
       <span class="keyword">self</span>.<span class="property">iapDelegate</span>.<span class="property">selectedProduct</span> = <span class="keyword">self</span>.<span class="property">iapDelegate</span>.<span class="property">productsArray</span>.<span class="call">firstIndex</span>(of: item)
       <span class="keyword">let</span> payment = <span class="type">SKPayment</span>(product: <span class="keyword">self</span>.<span class="property">iapDelegate</span>.<span class="property">productsArray</span>[<span class="keyword">self</span>.<span class="property">iapDelegate</span>.<span class="property">selectedProduct</span>] <span class="keyword">as</span> <span class="type">SKProduct</span>)
       <span class="type">SKPaymentQueue</span>.<span class="call">default</span>().<span class="call">add</span>(payment)
       <span class="keyword">self</span>.<span class="property">iapDelegate</span>.<span class="property">transactionInProgress</span> = <span class="keyword">true
       self</span>.<span class="property">alertIsShowing</span> = <span class="keyword">false</span>
     },
     secondaryButton: .<span class="call">cancel</span>(<span class="type">Text</span>(<span class="string">"No"</span>)){
       <span class="keyword">self</span>.<span class="property">alertIsShowing</span> = <span class="keyword">false</span>
     })
 })
</code></pre><p>OK, let's go back to the <code>IAPViewDelegate</code> class, and implement our method from the observer protocol. <code>paymentQueue(_:updatedTransactions:)</code> is our focus here. We’ll look at the transactions that were handed back to us from the store, and in particular the transaction state. Let’s make a switch statement to handle our different cases.</p><pre><code><span class="comment">//payment</span>
<span class="keyword">func</span> paymentQueue(<span class="keyword">_</span> queue: <span class="type">SKPaymentQueue</span>, updatedTransactions transactions: [<span class="type">SKPaymentTransaction</span>])
{
  <span class="keyword">for</span> transaction <span class="keyword">in</span> transactions
  {
    <span class="keyword">switch</span> transaction.<span class="property">transactionState</span>
    {
    <span class="keyword">case</span> .<span class="dotAccess">purchased</span>:
      <span class="call">print</span>(<span class="string">"Transaction completed successfully."</span>)
      <span class="type">SKPaymentQueue</span>.<span class="call">default</span>().<span class="call">finishTransaction</span>(transaction)
      transactionInProgress = <span class="keyword">false</span>
      unlockAds()
      
    <span class="keyword">case</span> .<span class="dotAccess">failed</span>:
      <span class="call">print</span>(<span class="string">"Transaction Failed"</span>);
      <span class="type">SKPaymentQueue</span>.<span class="call">default</span>().<span class="call">finishTransaction</span>(transaction)
      transactionInProgress = <span class="keyword">false
      
    default</span>:
      <span class="call">print</span>(transaction.<span class="property">transactionState</span>.<span class="property">rawValue</span>)
    }
  }
}
</code></pre><p>Let's break that down:</p><ul><li>If it’s purchased, we’ll note the transaction as finished, set <code>transactionInProgress</code> to false, and call our <code>unlockAds</code> method.</li><li>If the transaction failed, again mark the transaction as finished, and set the <code>transactionInProgress</code> to false, but don’t call our <code>unlockAds</code> method.</li><li>Be sure to catch the default cases for the switch (we’re not handling them all here).</li></ul><p>Finally let’s make our very simple <code>unlockAds</code>unlockAds method, which simply sets that showAds flag in the UserDefaults to false.</p><pre><code><span class="comment">//unlock functionality</span>
<span class="keyword">func</span> unlockAds()
{
  <span class="keyword">let</span> defaults = <span class="type">UserDefaults</span>.<span class="property">standard</span>
  defaults.<span class="call">set</span>(<span class="keyword">false</span>, forKey: <span class="string">"showAds"</span>)
}
</code></pre><p>Let’s run that in the simulator.</p><p>Push the button to get our list of IAP, and select the Disable Ads item. We see our dialog asking if the user wants to purchase the IAP or not.</p><p>If we were going through App Store Connect, we don’t have this IAP in a state that we can properly test it (it’s not marked as Ready for sale), so we won’t go any further down the purchase path. If we did select “Buy”, it would add our payment to the queue, and when the store responds, the <code>paymentQueue(_:updatedTransactions:)</code> method gets invoked - and we respond accordingly based on the transaction state.</p><p>However, we have our StoreKit Configuration File setup, so you can go through the full test process - the dialog even comments that this is for testing purposes only and you won't be charged.<br><br>It doesn’t take much to get in app purchases in your app, and it makes heavy use of delegate methods to handle responses from the store.</p><p>If you have any questions about the example in this video, please post them in the forums.</p><p style="float: left">Previous:  <A HREF="../../Week08/06-IAPItemsList/index.html">IAP Items List</A></p><p style="float: right">Next:  <A HREF="../../Week09/00-Week09Overview/index.html">Week 09 Overview</A></p><BR/><BR/></div><leftside><u><p>Week 8</p></u><div class="weekSection"><ul><li><div class="comment-container"><div class="tocItem"><a id="Week 08 Overview" href="../../Week08/00-Week08Overview/index.html">Week 08 Overview</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="Introduction to AVKit" href="../../Week08/01-IntroductionToAVKit/index.html">Introduction to AVKit</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="AVKit Example" href="../../Week08/02-AVKitExample/index.html">AVKit Example</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="Introduction to InAppPurchases" href="../../Week08/03-IntroductionToInAppPurchases/index.html">Introduction to InAppPurchases</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="IAP Enabling" href="../../Week08/04-IAPEnabling/index.html">IAP Enabling</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="IAP Creating" href="../../Week08/05-IAPCreating/index.html">IAP Creating</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="IAP Items List" href="../../Week08/06-IAPItemsList/index.html">IAP Items List</a></div><div class="chain chain-bottom"></div></div></li><li><div class="comment-container"><div class="chain chain-top"></div><div class="tocItem"><a id="IAP Purchasing" href="../../Week08/07-IAPPurchasing/index.html">IAP Purchasing</a></div></div></li></ul></div></leftside><footer><p>Generated with ❤️ using <a href="https://github.com/johnsundell/publish">Publish</a></p><p>© 2023-2024 Josh Steele (rsteele3@jhu.edu) <a href="mailto:"(rsteele3@jhu.edu)""></a></p><p>Last updated January 25, 2025 at 6:17 PM</p><p><a href="https://mastodon.social/@hococoder" target="_blank">My Mastodon</a> | <a href="https://github.com/hococoder" target="_blank">My GitHub</a> | <a href="https://ep.jhu.edu" target="_blank">Whiting School EPP</a> | <a href="https://canvas.jhu.edu" target="_blank">JHU Canvas</a></p></footer></div></body></html>